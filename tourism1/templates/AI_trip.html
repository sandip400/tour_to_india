{% extends "base.html" %}
{% block content %}
{% load static %}

<style>
/* Base styles */
.container {
    max-width: 1200px;
    margin: 0 auto;
}

form {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

form div {
    margin-bottom: 15px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

textarea {
    min-height: 100px;
    resize: vertical;
}

button {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s;
}

button:hover {
    background: #0056b3;
}

.error {
    color: #dc3545;
    padding: 10px;
    background: #f8d7da;
    border-radius: 5px;
    margin-bottom: 20px;
}

.warning {
    color: #856404;
    padding: 10px;
    background: #fff3cd;
    border-radius: 5px;
    margin-bottom: 20px;
}

.success {
    color: #155724;
    padding: 10px;
    background: #d4edda;
    border-radius: 5px;
    margin-bottom: 20px;
}

.place-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.trip-summary {
    background: #e9f7fe;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 4px solid #007bff;
}

/* Voice input styles */
.voice-input-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.voice-button {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.voice-button:hover {
    background: #218838;
    transform: scale(1.05);
}

.voice-button.recording {
    background: #dc3545;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.voice-status {
    font-size: 14px;
    color: #666;
    margin-left: 10px;
}

/* Enhanced input section styles */
.enhanced-input-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.enhanced-input-section h3 {
    color: white;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.5rem;
}

.input-method-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 5px;
}

.input-tab {
    flex: 1;
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s;
    font-weight: 500;
}

.input-tab.active {
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.input-method {
    display: none;
}

.input-method.active {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
}

.description-input {
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    border: none;
    border-radius: 10px;
    padding: 15px;
    font-size: 16px;
    line-height: 1.5;
}

.description-input::placeholder {
    color: #666;
}

.voice-input-area {
    text-align: center;
    padding: 20px;
}

.voice-input-area .voice-button {
    width: 80px;
    height: 80px;
    font-size: 24px;
    margin-bottom: 15px;
}

.voice-transcript {
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    min-height: 60px;
    display: none;
}

.process-button {
    background: #28a745;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    margin-top: 15px;
    transition: all 0.3s;
}

.process-button:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

/* Image gallery styles */
.place-images {
    margin: 15px 0;
}

.image-gallery {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 10px 0;
}

.place-image {
    min-width: 200px;
    height: 150px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s;
}

.place-image:hover {
    transform: scale(1.05);
}

.image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.modal-content {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    max-height: 80%;
    object-fit: contain;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

/* Transport and itinerary styles */
.transport-card {
    background: linear-gradient(135deg, #ffffff 0%, #f0f4f8 100%);
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.transport-card:hover {
    transform: translateY(-5px);
}

.transport-option {
    display: flex;
    align-items: center;
    margin: 8px 0;
    padding: 8px;
    border-radius: 6px;
    background-color: #f9f9f9;
}

.transport-option i {
    font-size: 20px;
    margin-right: 10px;
    color: #007bff;
}

.transport-option.recommended {
    background-color: #e6f7ff;
    border-left: 3px solid #0056b3;
    font-weight: 500;
}

.itinerary-timeline {
    position: relative;
    padding-left: 40px;
}

.itinerary-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    height: 100%;
    width: 2px;
    background: linear-gradient(to bottom, #007bff, #28a745);
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -40px;
    top: 5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #007bff;
    border: 3px solid #fff;
    box-shadow: 0 0 0 2px #007bff;
}

.timeline-time {
    font-weight: bold;
    color: #1a3c34;
    min-width: 120px;
}

.timeline-content {
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-top: 5px;
}

.weather-badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9em;
    margin-top: 8px;
    background-color: #f0f4f8;
    color: #333;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
}

.tabs {
    display: flex;
    margin-bottom: 20px;
    background: #f0f4f8;
    border-radius: 8px;
    overflow: hidden;
}

.tab-button {
    padding: 12px 20px;
    background: #f0f4f8;
    border: none;
    cursor: pointer;
    flex-grow: 1;
    transition: background 0.3s;
}

.tab-button.active {
    background: #007bff;
    color: white;
}

/* Daily plan styles */
.daily-plan {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.daily-plan h4 {
    color: #007bff;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

/* Budget section styles */
.budget-breakdown {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.budget-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.budget-total {
    font-weight: bold;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 2px solid #dee2e6;
}

/* Calendar styles */
.date-picker-container {
    position: relative;
}

.flatpickr-input {
    background: white;
    cursor: pointer;
}

/* Weather info styles */
.weather-info {
    display: flex;
    align-items: center;
    margin-top: 10px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.weather-icon {
    font-size: 24px;
    margin-right: 10px;
}

.transport-details {
    background-color: #f0f8ff;
    border-left: 3px solid #007bff;
    padding: 10px;
}

.transport-details ul {
    margin-bottom: 0;
    padding-left: 20px;
}

.transport-details li {
    margin-bottom: 5px;
}

.budget-friendly {
    color: #28a745;
    font-weight: 500;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    flex-direction: column;
}

.spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #007bff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Coordinate search status */
.coordinate-status {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    margin: 15px 0;
    border-radius: 5px;
}

.coordinate-status h6 {
    color: #1565c0;
    margin-bottom: 10px;
    font-weight: 600;
}

.coordinate-found {
    color: #2e7d32;
    font-weight: 500;
}

.coordinate-searching {
    color: #f57c00;
    font-weight: 500;
}

.coordinate-failed {
    color: #d32f2f;
    font-weight: 500;
}

/* Mobile responsive enhancements */
@media (max-width: 768px) {
    .tabs {
        flex-direction: column;
    }
    
    .itinerary-timeline {
        padding-left: 30px;
    }
    
    .timeline-item::before {
        left: -30px;
        width: 15px;
        height: 15px;
    }
    
    form {
        padding: 15px;
    }
    
    .image-gallery {
        flex-direction: column;
    }
    
    .place-image {
        min-width: 100%;
        height: 200px;
    }
    
    .input-method-tabs {
        flex-direction: column;
    }
    
    .enhanced-input-section {
        padding: 20px;
    }
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Hero section */
.hero-section {
    background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('/static/path.png');
    background-size: cover;
    background-position: center;
    background-opacity: 0.5;
    color: white;
    padding: 60px 0;
    margin-bottom: 30px;
    border-radius: 10px;
    text-align: center;
}

.hero-title {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.hero-subtitle {
    font-size: 1.2rem;
    margin-bottom: 30px;
    opacity: 0.9;
}

/* Nearby attraction styles */
.nearby-attraction-badge {
    display: inline-block;
    background-color: #e6f7ff;
    color: #0056b3;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    margin-left: 8px;
}

.nearby-attraction-description {
    font-style: italic;
    color: #666;
    margin-top: 5px;
}

/* Cultural information styles */
.cultural-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #28a745;
}

.cultural-section h6 {
    color: #28a745;
    margin-bottom: 10px;
    font-weight: 600;
}

.hidden-gems-section {
    background: #fff3cd;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #ffc107;
}

.hidden-gems-section h6 {
    color: #856404;
    margin-bottom: 10px;
    font-weight: 600;
}

.clothing-section {
    background: #e2e3e5;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #6c757d;
}

.clothing-section h6 {
    color: #495057;
    margin-bottom: 10px;
    font-weight: 600;
}

.tips-section {
    background: #d1ecf1;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #17a2b8;
}

.tips-section h6 {
    color: #0c5460;
    margin-bottom: 10px;
    font-weight: 600;
}

/* Weather during visit styles */
.visit-weather-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    border-left: 4px solid #2196f3;
}

.visit-weather-card h6 {
    color: #1565c0;
    margin-bottom: 10px;
    font-weight: 600;
}

.weather-day-card {
    background: white;
    border-radius: 6px;
    padding: 10px;
    margin: 8px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.weather-day-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.weather-temp {
    font-weight: bold;
    color: #1565c0;
}

/* Progress indicator */
.progress-indicator {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid #007bff;
}

.progress-step {
    display: flex;
    align-items: center;
    margin: 8px 0;
}

.progress-step.completed {
    color: #28a745;
}

.progress-step.current {
    color: #007bff;
    font-weight: bold;
}

.progress-step.pending {
    color: #6c757d;
}

.progress-icon {
    margin-right: 10px;
    font-size: 16px;
}
</style>

<div class="container">
<!-- Hero Section -->
<div class="hero-section">
  <br><br><br>
    <h1 class="hero-title">🧠 AI-Powered Tourist Trip Planner</h1>
    <p class="hero-subtitle">Create your perfect itinerary with our intelligent travel assistant powered by Gemini AI</p>
</div>

<!-- Enhanced Input Section -->
<div class="enhanced-input-section">
    <h3>🎯 Tell Us About Your Dream Trip</h3>
    <div class="input-method-tabs">
        <button class="input-tab active" onclick="switchInputMethod('description')">📝 Describe Your Trip</button>
        <button class="input-tab" onclick="switchInputMethod('voice')">🎤 Voice Input</button>
        <button class="input-tab" onclick="switchInputMethod('form')">📋 Quick Form</button>
    </div>
    
    <!-- Description Input Method -->
    <div id="description-method" class="input-method active">
        <textarea id="trip-description" class="description-input" placeholder="Describe your ideal trip in detail... For example: 'I want to explore the cultural heritage of Rajasthan for 8 days with my family of 4. We're interested in palaces, forts, and traditional markets. Our budget is around 1.5 lakhs and we prefer mid-range hotels. We'd like to experience local festivals and try authentic Rajasthani cuisine.'"></textarea>
        <div style="text-align: center;">
            <button class="process-button" onclick="processTripDescription()">✨ Create My Itinerary</button>
        </div>
    </div>
    
    <!-- Voice Input Method -->
    <div id="voice-method" class="input-method">
        <div class="voice-input-area">
            <button id="enhanced-voice-button" class="voice-button" onclick="startEnhancedVoiceInput()">🎤</button>
            <p>Click the microphone and describe your trip in detail</p>
            <div id="voice-transcript" class="voice-transcript"></div>
            <button id="process-voice" class="process-button" style="display: none;" onclick="processVoiceDescription()">✨ Create My Itinerary</button>
        </div>
    </div>
    
    <!-- Quick Form Method -->
    <div id="form-method" class="input-method">
        <p style="text-align: center; margin-bottom: 20px;">Use the detailed form below for precise planning</p>
        <div style="text-align: center;">
            <button class="process-button" onclick="scrollToForm()">📋 Go to Form</button>
        </div>
    </div>
</div>

<form method="post" id="tripForm">
    {% csrf_token %}
    <input type="hidden" name="trip_description" id="hidden-trip-description" />
    
    <div class="row">
        <div class="col-md-6">
            <div>
                <label>🗓️ Travel Dates:</label>
                <div class="date-picker-container">
                    <input type="text" id="date-range" name="date_range" placeholder="Select date range" required />
                    <input type="hidden" id="days" name="days" />
                </div>
            </div>
            
            <div>
                <label>👥 Number of Members:</label>
                <input type="number" name="members" min="1" required />
            </div>
        </div>
        
        <div class="col-md-6">
            <div>
                <label>💰 Budget (in INR):</label>
                <input type="number" name="budget" min="1000" placeholder="Enter your budget in INR" required />
            </div>
            
            <div>
                <label>📍 Places to Visit (comma separated):</label>
                <input type="text" id="places-input" name="places" placeholder="e.g., Delhi, Agra, Jaipur" required />
                <div class="voice-input-container">
                    <button type="button" id="voiceButton" class="voice-button" title="Click to speak your trip details">
                        🎤
                    </button>
                    <span id="voiceStatus" class="voice-status">Click the microphone to speak your trip details</span>
                </div>
            </div>
        </div>
    </div>

    <button type="submit" id="planButton">🚀 Plan My Trip</button>
</form>

{% if error %}
    <div class="error">{{ error }}</div>
{% endif %}

{% if warning %}
    <div class="warning">{{ warning }}</div>
{% endif %}

{% if coordinate_search_status %}
    <div class="coordinate-status">
        <h6>🔍 Coordinate Search Status</h6>
        {% for status in coordinate_search_status %}
            <div class="progress-step {% if status.found %}completed{% else %}failed{% endif %}">
                <span class="progress-icon">
                    {% if status.found %}✅{% else %}❌{% endif %}
                </span>
                <span>{{ status.place }}: 
                    {% if status.found %}
                        <span class="coordinate-found">Found at ({{ status.latitude }}, {{ status.longitude }})</span>
                    {% else %}
                        <span class="coordinate-failed">{{ status.error }}</span>
                    {% endif %}
                </span>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if places %}
<hr />
<div class="trip-summary">
    <h3>✨ Trip Summary</h3>
    <div class="row">
        <div class="col-md-6">
            <p><strong>Travel Dates:</strong> {{ start_date }} to {{ end_date }}</p>
            <p><strong>Days:</strong> {{ days }}</p>
            <p><strong>Members:</strong> {{ members }}</p>
            <p><strong>Budget:</strong> ₹{{ budget }}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Travel Path:</strong> {{ travel_path }}</p>
            <p><strong>Total Distance:</strong> {{ total_distance }}</p>
            <p><strong>Budget Per Person:</strong> ₹{{ budget_per_person }}</p>
        </div>
    </div>
</div>

<hr />

<!-- Tab Navigation -->
<div class="tabs">
    <button class="tab-button active" onclick="openTab('itinerary')">📅 Day-by-Day Itinerary</button>
    <button class="tab-button" onclick="openTab('places')">📍 Places Information</button>
    <button class="tab-button" onclick="openTab('map')">🗺️ Trip Map</button>
    <button class="tab-button" onclick="openTab('budget')">💰 Budget Breakdown</button>
    <button class="tab-button" onclick="openTab('weather')">🌤️ Weather Forecast</button>
</div>

<!-- Itinerary Tab -->
<div id="itinerary" class="tab-content active">
    <h3>📅 Day-by-Day Itinerary</h3>
    {% for day in daily_plan %}
    <div class="daily-plan">
        <h4>{{ day.day }} - {{ day.date }}</h4>
        <p><strong>Places:</strong> 
            {% for place in day.places %}
                {{ place }}
                {% if forloop.last %}{% else %}, {% endif %}
            {% endfor %}
        </p>
        
        <div class="itinerary-timeline">
            {% for item in day.itinerary_items %}
                <div class="timeline-item">
                    <div class="timeline-time">{{ item.time }}</div>
                    <div class="timeline-content">
                        {{ item.content }}
                        
                        {% if item.transport_details %}
                        <div class="transport-details">
                            <strong>Transport Options:</strong>
                            <ul>
                                {% for option in item.transport_details %}
                                    <li>
                                        <strong>{{ option.mode }}:</strong> 
                                        {{ option.duration }} - ₹{{ option.cost }} 
                                        {% if option.budget_friendly %}
                                            <span class="budget-friendly">(Budget-friendly)</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                            <p><strong>Recommended:</strong> {{ item.recommended_transport }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Places Tab -->
<div id="places" class="tab-content">
    <h3>📍 Place Details</h3>
    {% for place in places %}
    <div class="place-card">
        <h4>
            📍 {{ place.name }}
            {% if place.is_nearby_attraction %}
                <span class="nearby-attraction-badge">Near {{ place.main_destination }}</span>
            {% endif %}
            {% if place.is_additional %}
                <span class="nearby-attraction-badge">Additional Destination</span>
            {% endif %}
        </h4>
        
        {% if place.is_nearby_attraction %}
            <p class="nearby-attraction-description">{{ place.description }}</p>
            <p><strong>Distance:</strong> {{ place.distance_from_main }} km from {{ place.main_destination }}</p>
            <p><strong>Type:</strong> {{ place.attraction_type|title }}</p>
        {% endif %}

        {% if place.is_additional %}
            <p class="nearby-attraction-description">{{ place.reason_to_visit }}</p>
        {% endif %}

        <!-- Place Images -->
        {% if place.images %}
        <div class="place-images">
            <h6>📸 Images of {{ place.name }}</h6>
            <div class="image-gallery">
                {% for image in place.images %}
                    <img src="{{ image.url }}" alt="{{ image.title }}" class="place-image" onclick="openImageModal('{{ image.url }}', '{{ image.title }}')">
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div>
            <strong>🛤️ Location Coordinates:</strong> ({{ place.latitude|floatformat:5 }}, {{ place.longitude|floatformat:5 }})
        </div>
        
        <div class="weather-info">
            <div class="weather-icon">
                {% if 'clear' in place.current_weather|lower %}
                    <i class="fas fa-sun" style="color: #FFD700;"></i>
                {% elif 'cloud' in place.current_weather|lower %}
                    <i class="fas fa-cloud" style="color: #A9A9A9;"></i>
                {% elif 'rain' in place.current_weather|lower %}
                    <i class="fas fa-cloud-rain" style="color: #4682B4;"></i>
                {% elif 'thunder' in place.current_weather|lower %}
                    <i class="fas fa-bolt" style="color: #FFD700;"></i>
                {% elif 'snow' in place.current_weather|lower %}
                    <i class="fas fa-snowflake" style="color: #ADD8E6;"></i>
                {% elif 'mist' in place.current_weather|lower or 'fog' in place.current_weather|lower %}
                    <i class="fas fa-smog" style="color: #D3D3D3;"></i>
                {% else %}
                    <i class="fas fa-cloud-sun" style="color: #87CEEB;"></i>
                {% endif %}
            </div>
            <div>
                <strong>Current Weather:</strong> {{ place.current_weather }}
            </div>
        </div>

        {% if place.top_attractions and place.top_attractions|length > 0 and place.top_attractions.0 != "No specific attractions found" %}
        <div>
            <strong>🏛️ Top Attractions:</strong>
            <ul>
                {% for attraction in place.top_attractions %}
                    <li>{{ attraction }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if place.hidden_gems and place.hidden_gems|length > 0 and place.hidden_gems.0 != "No hidden gems found" and "No specific" not in place.hidden_gems.0 and "not available" not in place.hidden_gems.0|lower %}
<div class="hidden-gems-section">
<h6>💎 Hidden Gems & Off-the-Beaten-Path Experiences</h6>
<div class="row">
    {% for gem in place.hidden_gems %}
        <div class="col-md-6 mb-2">
            <div style="background: #fff8e1; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;">
                <strong>{{ gem|truncatewords:3 }}</strong>
                <p style="margin: 5px 0; font-size: 0.9em;">{{ gem }}</p>
                <small style="color: #856404;">
                    <i class="fas fa-clock"></i> Best visited during early morning or late afternoon
                </small>
            </div>
        </div>
    {% endfor %}
</div>
<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 5px;">
    <small><strong>💡 Insider Tip:</strong> These hidden gems are less crowded and offer authentic local experiences. Consider hiring a local guide for the best experience.</small>
</div>
</div>
{% endif %}

        {% if place.local_culture and place.local_culture.traditions != "Local traditions information not available" and place.local_culture.festivals != "Festival information not available" %}
<div class="cultural-section">
<h6>🎭 Local Culture & Rich Traditions</h6>
<div class="row">
    <div class="col-md-6">
        {% if place.local_culture.traditions != "Local traditions information not available" %}
        <div style="background: white; padding: 12px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-hands-helping"></i> Traditions:</strong>
            <p style="margin: 5px 0;">{{ place.local_culture.traditions }}</p>
        </div>
        {% endif %}
        {% if place.local_culture.art_forms != "Art forms information not available" %}
        <div style="background: white; padding: 12px; border-radius: 5px;">
            <strong><i class="fas fa-palette"></i> Art Forms:</strong>
            <p style="margin: 5px 0;">{{ place.local_culture.art_forms }}</p>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6">
        {% if place.local_culture.festivals != "Festival information not available" %}
        <div style="background: white; padding: 12px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-calendar-alt"></i> Festivals:</strong>
            <p style="margin: 5px 0;">{{ place.local_culture.festivals }}</p>
        </div>
        {% endif %}
        {% if place.local_culture.languages != "Language information not available" %}
        <div style="background: white; padding: 12px; border-radius: 5px;">
            <strong><i class="fas fa-language"></i> Languages:</strong>
            <p style="margin: 5px 0;">{{ place.local_culture.languages }}</p>
        </div>
        {% endif %}
    </div>
</div>
<div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 5px;">
    <small><strong>🌟 Cultural Etiquette:</strong> Respect local customs, dress modestly when visiting religious sites, and always ask permission before photographing people.</small>
</div>
</div>
{% endif %}

        {% if place.traditional_clothing %}
<div class="clothing-section">
<h6>👘 Traditional Attire & Cultural Dress</h6>
<div class="row">
    <div class="col-md-6">
        <div style="background: white; padding: 12px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-male"></i> Men's Traditional Wear:</strong>
            <p style="margin: 5px 0;">{{ place.traditional_clothing.men }}</p>
        </div>
        <div style="background: white; padding: 12px; border-radius: 5px;">
            <strong><i class="fas fa-calendar-check"></i> Special Occasions:</strong>
            <p style="margin: 5px 0;">{{ place.traditional_clothing.occasions }}</p>
        </div>
    </div>
    <div class="col-md-6">
        <div style="background: white; padding: 12px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-female"></i> Women's Traditional Wear:</strong>
            <p style="margin: 5px 0;">{{ place.traditional_clothing.women }}</p>
        </div>
        <div style="background: white; padding: 12px; border-radius: 5px;">
            <strong><i class="fas fa-shopping-bag"></i> Where to Buy:</strong>
            <p style="margin: 5px 0;">{{ place.traditional_clothing.where_to_buy }}</p>
        </div>
    </div>
</div>
<div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px;">
    <small><strong>✨ Shopping Tip:</strong> Bargaining is common in local markets. Start at 50-60% of the quoted price and negotiate respectfully.</small>
</div>
</div>
{% endif %}

        {% if place.cultural_experiences and place.cultural_experiences|length > 0 and place.cultural_experiences.0 != "No specific cultural experiences found" %}
        <div class="cultural-section">
            <h6>🎪 Unique Cultural Experiences</h6>
            <ul>
                {% for experience in place.cultural_experiences %}
                    <li>{{ experience }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if place.shopping_spots and place.shopping_spots|length > 0 and place.shopping_spots.0 != "No specific shopping spots found" %}
        <div>
            <strong>🛍️ Shopping Spots:</strong>
            <ul>
                {% for spot in place.shopping_spots %}
                    <li>{{ spot }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if place.local_tips and place.local_tips|length > 0 and place.local_tips.0 != "No specific tips available" %}
        <div class="tips-section">
            <h6>💡 Local Insider Tips</h6>
            <ul>
                {% for tip in place.local_tips %}
                    <li>{{ tip }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

{% if place.booking_links %}
<div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #2196f3;">
<h6>🔗 Booking & Reservations</h6>
<div class="row">
    <div class="col-md-4">
        <div style="background: white; padding: 10px; border-radius: 5px;">
            <strong><i class="fas fa-bed"></i> Hotels:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for hotel_platform in place.booking_links.hotels %}
                    <li style="margin-bottom: 3px;">
                        <a href="#" target="_blank" style="color: #1976d2; text-decoration: none;">{{ hotel_platform }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div style="background: white; padding: 10px; border-radius: 5px;">
            <strong><i class="fas fa-ticket-alt"></i> Activities:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for activity_platform in place.booking_links.activities %}
                    <li style="margin-bottom: 3px;">
                        <a href="#" target="_blank" style="color: #1976d2; text-decoration: none;">{{ activity_platform }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div style="background: white; padding: 10px; border-radius: 5px;">
            <strong><i class="fas fa-bus"></i> Transport:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for transport_platform in place.booking_links.transport %}
                    <li style="margin-bottom: 3px;">
                        <a href="#" target="_blank" style="color: #1976d2; text-decoration: none;">{{ transport_platform }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
</div>
{% endif %}

{% if place.shopping_links %}
<div style="background: #f3e5f5; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #9c27b0;">
<h6>🛍️ Shopping & Local Markets</h6>
<div class="row">
    <div class="col-md-6">
        <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-store"></i> Local Markets:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for market in place.shopping_links.local_markets %}
                    <li style="margin-bottom: 3px;">{{ market }}</li>
                {% endfor %}
            </ul>
        </div>
        <div style="background: white; padding: 10px; border-radius: 5px;">
            <strong><i class="fas fa-building"></i> Shopping Malls:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for mall in place.shopping_links.malls %}
                    <li style="margin-bottom: 3px;">{{ mall }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-6">
        <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong><i class="fas fa-palette"></i> Handicrafts:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for handicraft in place.shopping_links.handicrafts %}
                    <li style="margin-bottom: 3px;">{{ handicraft }}</li>
                {% endfor %}
            </ul>
        </div>
        <div style="background: white; padding: 10px; border-radius: 5px;">
            <strong><i class="fas fa-laptop"></i> Online Shopping:</strong>
            <ul style="margin: 5px 0; padding-left: 15px;">
                {% for online_platform in place.shopping_links.online_shopping %}
                    <li style="margin-bottom: 3px;">
                        <a href="#" target="_blank" style="color: #7b1fa2; text-decoration: none;">{{ online_platform }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<div style="margin-top: 10px; padding: 8px; background: #fce4ec; border-radius: 5px;">
    <small><strong>💳 Shopping Tip:</strong> Carry cash for local markets, bargain respectfully, and always check for authenticity certificates when buying handicrafts.</small>
</div>
</div>
{% endif %}

        {% if place.restaurants and place.restaurants|length > 0 and place.restaurants.0 != "No specific restaurants found" %}
        <div>
            <strong>🍽️ Famous Restaurants:</strong>
            <ul>
                {% for restaurant in place.restaurants %}
                    <li>{{ restaurant }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if place.hospitals and place.hospitals|length > 0 and place.hospitals.0 != "No specific hospitals found" %}
        <div>
            <strong>🏥 Nearby Hospitals:</strong>
            <ul>
                {% for hospital in place.hospitals %}
                    <li>{{ hospital }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if place.transport and place.transport != "No specific transport info available" %}
        <div>
            <strong>🚆 Transport Facilities:</strong>
            <p>{{ place.transport }}</p>
        </div>
        {% endif %}
        
        {% if place.distances and place.distances|length > 0 %}
        <div>
            <strong>📏 Distances to Other Places:</strong>
            <ul>
                {% for distance in place.distances %}
                    <li>To {{ distance.to }}: {{ distance.distance }} ({{ distance.duration }})</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Map Tab -->
<div id="map" class="tab-content">
    <h3>🗺️ Trip Route Map</h3>
    <div id="trip-map" style="height: 500px;"></div>
    
    <div class="transport-info mt-4">
        <h4>🚗 Transport Information</h4>
        {% for transport in transport_info %}
        <div class="transport-card">
            <h5>{{ transport.from }} to {{ transport.to }}</h5>
            <p><strong>Distance:</strong> {{ transport.distance }}</p>
            <p><strong>Duration:</strong> {{ transport.duration }}</p>
            
            <h6>Transport Options:</h6>
            {% for option in transport.options %}
            <div class="transport-option {% if option.recommended %}recommended{% endif %}">
                <i class="fas fa-{% if option.mode == 'Car' %}car{% elif option.mode == 'Train' %}train{% elif option.mode == 'Bus' %}bus{% elif option.mode == 'Flight' %}plane{% endif %}"></i>
                <div>
                    <strong>{{ option.mode }}</strong> {% if option.recommended %}(Recommended){% endif %}
                    <div>Duration: {{ option.duration }} | Cost: ₹{{ option.cost }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Budget Tab -->
<div id="budget" class="tab-content">
    <h3>💰 Budget Breakdown</h3>
    
    <div class="budget-breakdown">
        <div class="budget-item">
            <span>Total Budget:</span>
            <span>₹{{ budget }}</span>
        </div>
        <div class="budget-item">
            <span>Budget Per Person:</span>
            <span>₹{{ budget_per_person }}</span>
        </div>
        <div class="budget-item">
            <span>Budget Per Day:</span>
            <span>₹{{ budget_per_day }}</span>
        </div>
        
        <h4 class="mt-4">Estimated Expenses</h4>
        
        {% for expense in budget_breakdown %}
        <div class="budget-item">
            <span>{{ expense.category }}:</span>
            <span>₹{{ expense.amount }}</span>
        </div>
        {% endfor %}
        
        <div class="budget-item budget-total">
            <span>Total Estimated Expenses:</span>
            <span>₹{{ total_estimated_expenses }}</span>
        </div>
        
        <div class="budget-item">
            <span>Remaining Budget (Buffer):</span>
            <span>₹{{ remaining_budget }}</span>
        </div>
    </div>
    
    <div class="mt-4">
        <h4>💡 Budget Tips</h4>
        <ul>
            {% for tip in budget_tips %}
            <li>{{ tip }}</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Weather Tab -->
<div id="weather" class="tab-content">
    <h3>🌤️ Weather Forecast</h3>
    
    <!-- Weather During Your Visit Section -->
<div class="visit-weather-card">
<h6>🗓️ Weather During Your Travel Period ({{ start_date }} to {{ end_date }})</h6>
<div class="row">
    {% for day in daily_plan %}
        <div class="col-md-6 mb-3">
            <div class="weather-day-card">
                <div class="weather-day-info">
                    <div>
                        {% for place in places %}
                            {% if place.name in day.places %}
                                {% if place.forecast %}
                                    {% for forecast_day in place.forecast %}
                                        {% if day.date and forecast_day.date in day.date %}
                                            {% if 'clear' in forecast_day.condition|lower %}
                                                <i class="fas fa-sun" style="color: #FFD700;"></i>
                                            {% elif 'cloud' in forecast_day.condition|lower %}
                                                <i class="fas fa-cloud" style="color: #A9A9A9;"></i>
                                            {% elif 'rain' in forecast_day.condition|lower %}
                                                <i class="fas fa-cloud-rain" style="color: #4682B4;"></i>
                                            {% elif 'thunder' in forecast_day.condition|lower %}
                                                <i class="fas fa-bolt" style="color: #FFD700;"></i>
                                            {% elif 'snow' in forecast_day.condition|lower %}
                                                <i class="fas fa-snowflake" style="color: #ADD8E6;"></i>
                                            {% elif 'mist' in forecast_day.condition|lower or 'fog' in forecast_day.condition|lower %}
                                                <i class="fas fa-smog" style="color: #D3D3D3;"></i>
                                            {% else %}
                                                <i class="fas fa-cloud-sun" style="color: #87CEEB;"></i>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <i class="fas fa-cloud-sun" style="color: #87CEEB;"></i>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div>
                        <strong>{{ day.day }}</strong><br>
                        <small>{{ day.date }}</small><br>
                        <small>{{ day.places|join:", " }}</small>
                    </div>
                </div>
                <div class="weather-temp">
                    {% for place in places %}
                        {% if place.name in day.places %}
                            {% if place.forecast %}
                                {% for forecast_day in place.forecast %}
                                    {% if day.date and forecast_day.date in day.date %}
                                        {{ forecast_day.temp_min }}° - {{ forecast_day.temp_max }}°C
                                        <br><small>{{ forecast_day.condition }}</small>
                                        {% if forecast_day.humidity %}
                                            <br><small>Humidity: {{ forecast_day.humidity }}%</small>
                                        {% endif %}
                                        {% if forecast_day.wind_speed %}
                                            <br><small>Wind: {{ forecast_day.wind_speed }} m/s</small>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% if 'Currently' in place.current_weather %}
                                    {{ place.current_weather|slice:"10:15" }}°C
                                    <br><small>{{ place.current_weather|slice:"25:" }}</small>
                                {% else %}
                                    <small>Weather data not available</small>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>
<div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
    <small><strong>🌤️ Weather Planning Tip:</strong> This forecast covers 7 days before and after your travel dates to help you plan better. Pack accordingly based on the expected conditions during your visit.</small>
</div>
</div>
    
    <div class="weather-overview mb-4" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
        <h4>Trip Weather Overview</h4>
        <p>Weather information is crucial for planning your activities. Here's what to expect during your trip:</p>
        
        <div class="row">
            {% for day in daily_plan %}
                <div class="col-md-4 mb-3">
                    <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <strong>{{ day.day }} ({{ day.date }})</strong>
                        {% for item in day.itinerary_items %}
                            {% if "Weather Forecast" in item.content %}
                                <div style="margin-top: 5px;">
                                    {% if 'clear' in item.content|lower %}
                                        <i class="fas fa-sun" style="color: #FFD700;"></i>
                                    {% elif 'cloud' in item.content|lower %}
                                        <i class="fas fa-cloud" style="color: #A9A9A9;"></i>
                                    {% elif 'rain' in item.content|lower %}
                                        <i class="fas fa-cloud-rain" style="color: #4682B4;"></i>
                                    {% elif 'thunder' in item.content|lower %}
                                        <i class="fas fa-bolt" style="color: #FFD700;"></i>
                                    {% elif 'snow' in item.content|lower %}
                                        <i class="fas fa-snowflake" style="color: #ADD8E6;"></i>
                                    {% elif 'mist' in item.content|lower or 'fog' in item.content|lower %}
                                        <i class="fas fa-smog" style="color: #D3D3D3;"></i>
                                    {% else %}
                                        <i class="fas fa-cloud-sun" style="color: #87CEEB;"></i>
                                    {% endif %}
                                    {{ item.content|slice:"19:" }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="row">
        {% for place in places %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ place.name }}</h5>
                </div>
                <div class="card-body">
                    <div class="current-weather mb-3">
                        <h6>Current Weather</h6>
                        <div class="d-flex align-items-center">
                            <div class="weather-icon me-3">
                                {% if 'clear' in place.current_weather|lower %}
                                    <i class="fas fa-sun fa-2x" style="color: #FFD700;"></i>
                                {% elif 'cloud' in place.current_weather|lower %}
                                    <i class="fas fa-cloud fa-2x" style="color: #A9A9A9;"></i>
                                {% elif 'rain' in place.current_weather|lower %}
                                    <i class="fas fa-cloud-rain fa-2x" style="color: #4682B4;"></i>
                                {% elif 'thunder' in place.current_weather|lower %}
                                    <i class="fas fa-bolt fa-2x" style="color: #FFD700;"></i>
                                {% elif 'snow' in place.current_weather|lower %}
                                    <i class="fas fa-snowflake fa-2x" style="color: #ADD8E6;"></i>
                                {% elif 'mist' in place.current_weather|lower or 'fog' in place.current_weather|lower %}
                                    <i class="fas fa-smog fa-2x" style="color: #D3D3D3;"></i>
                                {% else %}
                                    <i class="fas fa-cloud-sun fa-2x" style="color: #87CEEB;"></i>
                                {% endif %}
                            </div>
                            <div>
                                {{ place.current_weather }}
                            </div>
                        </div>
                    </div>
                    
                    {% if place.forecast %}
                    <h6>7-Day Forecast</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Condition</th>
                                    <th>Temp (°C)</th>
                                    {% if place.forecast.0.humidity %}
                                    <th>Humidity</th>
                                    <th>Wind</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in place.forecast %}
                                <tr>
                                    <td>{{ day.date }}</td>
                                    <td>
                                        {% if 'clear' in day.condition|lower %}
                                            <i class="fas fa-sun" style="color: #FFD700;"></i>
                                        {% elif 'cloud' in day.condition|lower %}
                                            <i class="fas fa-cloud" style="color: #A9A9A9;"></i>
                                        {% elif 'rain' in day.condition|lower %}
                                            <i class="fas fa-cloud-rain" style="color: #4682B4;"></i>
                                        {% elif 'thunder' in day.condition|lower %}
                                            <i class="fas fa-bolt" style="color: #FFD700;"></i>
                                        {% elif 'snow' in day.condition|lower %}
                                            <i class="fas fa-snowflake" style="color: #ADD8E6;"></i>
                                        {% elif 'mist' in day.condition|lower or 'fog' in day.condition|lower %}
                                            <i class="fas fa-smog" style="color: #D3D3D3;"></i>
                                        {% else %}
                                            <i class="fas fa-cloud-sun" style="color: #87CEEB;"></i>
                                        {% endif %}
                                        {{ day.condition }}
                                    </td>
                                    <td>{{ day.temp_min }}° - {{ day.temp_max }}°</td>
                                    {% if day.humidity %}
                                    <td>{{ day.humidity }}%</td>
                                    <td>{{ day.wind_speed }} m/s</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>Forecast data not available.</p>
                    {% endif %}
                    
                    <div class="mt-3">
                        <h6>Best Time to Visit</h6>
                        <p>{{ place.best_time_to_visit }}</p>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Weather Tips</h6>
                        <ul>
                            {% if 'rain' in place.current_weather|lower or place.forecast|length > 0 and 'rain' in place.forecast.0.condition|lower %}
                                <li>Pack an umbrella or raincoat as rain is expected during your visit.</li>
                            {% endif %}
                            {% if place.forecast|length > 0 and place.forecast.0.temp_max > 30 %}
                                <li>High temperatures expected - bring light clothing, sunscreen, and stay hydrated.</li>
                            {% endif %}
                            {% if place.forecast|length > 0 and place.forecast.0.temp_min < 15 %}
                                <li>Cool temperatures expected - pack a light jacket or sweater for evenings.</li>
                            {% endif %}
                            {% if place.forecast|length > 0 and place.forecast.0.temp_min < 5 %}
                                <li>Cold temperatures expected - bring warm clothing and layers.</li>
                            {% endif %}
                            {% if place.forecast|length > 0 and place.forecast.0.humidity > 80 %}
                                <li>High humidity expected - wear breathable fabrics and stay hydrated.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImage">
    <div id="caption" style="text-align: center; color: white; padding: 10px;"></div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner"></div>
    <p>🔍 Searching coordinates with Gemini AI...</p>
    <p>📍 Planning your perfect itinerary...</p>
    <p>🖼️ Fetching beautiful images from Unsplash...</p>
</div>

{% endif %}
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// Voice recognition variables
let recognition;
let isRecording = false;
let enhancedRecognition;
let isEnhancedRecording = false;

// Initialize voice recognition
function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
            isRecording = true;
            document.getElementById('voiceButton').classList.add('recording');
            document.getElementById('voiceStatus').textContent = 'Listening... Speak your trip details';
        };
        
        recognition.onresult = function(event) {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            
            if (finalTranscript) {
                processVoiceInput(finalTranscript);
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            stopVoiceRecognition();
            document.getElementById('voiceStatus').textContent = 'Error: ' + event.error + '. Click to try again.';
        };
        
        recognition.onend = function() {
            stopVoiceRecognition();
        };

        // Initialize enhanced voice recognition
        enhancedRecognition = new SpeechRecognition();
        enhancedRecognition.continuous = true;
        enhancedRecognition.interimResults = true;
        enhancedRecognition.lang = 'en-US';
        
        enhancedRecognition.onstart = function() {
            isEnhancedRecording = true;
            document.getElementById('enhanced-voice-button').classList.add('recording');
        };
        
        enhancedRecognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            
            document.getElementById('voice-transcript').style.display = 'block';
            document.getElementById('voice-transcript').textContent = transcript;
            document.getElementById('process-voice').style.display = 'inline-block';
        };
        
        enhancedRecognition.onerror = function(event) {
            console.error('Enhanced speech recognition error:', event.error);
            stopEnhancedVoiceInput();
        };
        
        enhancedRecognition.onend = function() {
            stopEnhancedVoiceInput();
        };
    } else {
        document.getElementById('voiceStatus').textContent = 'Voice recognition not supported in this browser';
        document.getElementById('voiceButton').disabled = true;
    }
}

function startVoiceRecognition() {
    if (recognition && !isRecording) {
        recognition.start();
    }
}

function stopVoiceRecognition() {
    if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        document.getElementById('voiceButton').classList.remove('recording');
        document.getElementById('voiceStatus').textContent = 'Processing your input...';
    }
}

function startEnhancedVoiceInput() {
    if (enhancedRecognition && !isEnhancedRecording) {
        enhancedRecognition.start();
    }
}

function stopEnhancedVoiceInput() {
    if (enhancedRecognition && isEnhancedRecording) {
        enhancedRecognition.stop();
        isEnhancedRecording = false;
        document.getElementById('enhanced-voice-button').classList.remove('recording');
    }
}

function processVoiceInput(voiceText) {
    // Send voice input to backend for processing
    fetch('/process_voice_input/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'voice_text': voiceText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fill form fields with extracted data
            if (data.places && data.places.length > 0) {
                document.getElementById('places-input').value = data.places.join(', ');
            }
            if (data.days) {
                // Calculate date range based on days
                const today = new Date();
                const endDate = new Date(today);
                endDate.setDate(today.getDate() + data.days - 1);
                
                const startStr = today.toISOString().split('T')[0];
                const endStr = endDate.toISOString().split('T')[0];
                document.getElementById('date-range').value = `${startStr} to ${endStr}`;
                document.getElementById('days').value = data.days;
            }
            if (data.members) {
                document.querySelector('input[name="members"]').value = data.members;
            }
            if (data.budget) {
                document.querySelector('input[name="budget"]').value = data.budget;
            }
            
            document.getElementById('voiceStatus').textContent = 'Voice input processed successfully! ' + data.message;
        } else {
            document.getElementById('voiceStatus').textContent = 'Could not process voice input: ' + data.message;
        }
    })
    .catch(error => {
        console.error('Error processing voice input:', error);
        document.getElementById('voiceStatus').textContent = 'Error processing voice input. Please try again.';
    });
}

// Enhanced input methods
function switchInputMethod(method) {
    // Hide all methods
    document.querySelectorAll('.input-method').forEach(el => {
        el.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.input-tab').forEach(el => {
        el.classList.remove('active');
    });
    
    // Show selected method
    document.getElementById(method + '-method').classList.add('active');
    event.target.classList.add('active');
}

function processTripDescription() {
    const description = document.getElementById('trip-description').value;
    if (!description.trim()) {
        alert('Please describe your trip first.');
        return;
    }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    fetch('/process_trip_description/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'description': description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Set the hidden field and submit the form
            document.getElementById('hidden-trip-description').value = description;
            document.getElementById('tripForm').submit();
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert('Error processing description: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('Error:', error);
        alert('Error processing your trip description. Please try again.');
    });
}

function processVoiceDescription() {
    const transcript = document.getElementById('voice-transcript').textContent;
    if (!transcript.trim()) {
        alert('No voice input detected. Please try speaking again.');
        return;
    }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    fetch('/process_trip_description/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'description': transcript
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Set the hidden field and submit the form
            document.getElementById('hidden-trip-description').value = transcript;
            document.getElementById('tripForm').submit();
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert('Error processing voice input: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('Error:', error);
        alert('Error processing your voice input. Please try again.');
    });
}

function scrollToForm() {
    document.getElementById('tripForm').scrollIntoView({ behavior: 'smooth' });
}

// Image modal functions
function openImageModal(imageSrc, imageTitle) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('caption');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
    caption.textContent = imageTitle;
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Tab functionality
function openTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Initialize map if map tab is opened
    if (tabName === 'map' && typeof initMap === 'function') {
        setTimeout(initMap, 100);
    }
}

// Initialize date picker and voice recognition
document.addEventListener('DOMContentLoaded', function() {
    // Initialize voice recognition
    initVoiceRecognition();
    
    // Voice button event listener
    document.getElementById('voiceButton').addEventListener('click', function() {
        if (isRecording) {
            stopVoiceRecognition();
        } else {
            startVoiceRecognition();
        }
    });

    // Enhanced voice button event listener
    document.getElementById('enhanced-voice-button').addEventListener('click', function() {
        if (isEnhancedRecording) {
            stopEnhancedVoiceInput();
        } else {
            startEnhancedVoiceInput();
        }
    });

    // Initialize flatpickr
    const dateRangePicker = flatpickr("#date-range", {
        mode: "range",
        minDate: "today",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('days').value = diffDays;
            }
        },
        onReady: function(selectedDates, dateStr, instance) {
            // Set default dates (7 days from today)
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            instance.setDate([today, nextWeek]);
        }
    });

    // Form submission with loading overlay
    document.getElementById('tripForm').addEventListener('submit', function() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
            closeImageModal();
        }
    }
});

// Map initialization function (if places data exists)
{% if places %}
function initMap() {
    if (document.getElementById('trip-map') && typeof L !== 'undefined') {
        // Clear existing map
        const mapContainer = document.getElementById('trip-map');
        mapContainer.innerHTML = '';
        
        // Initialize the map
        const map = L.map('trip-map').setView([{{ places.0.latitude }}, {{ places.0.longitude }}], 6);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add markers for each place
        const places = [
            {% for place in places %}
            {
                name: "{{ place.name }}",
                lat: {{ place.latitude }},
                lng: {{ place.longitude }},
                isNearbyAttraction: {{ place.is_nearby_attraction|yesno:"true,false" }},
                mainDestination: "{{ place.main_destination|default:'' }}",
                distanceFromMain: {{ place.distance_from_main|default:0 }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        places.forEach(function(place, index) {
            let markerColor = place.isNearbyAttraction ? 'orange' : 'blue';
            let popupContent = `<strong>${place.name}</strong>`;
            
            if (place.isNearbyAttraction) {
                popupContent += `<br><small>Near ${place.mainDestination} (${place.distanceFromMain} km)</small>`;
            }
            
            const marker = L.marker([place.lat, place.lng]).addTo(map);
            marker.bindPopup(popupContent);
            
            // Add number label to marker
            const numberIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${markerColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${index + 1}</div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            });
            marker.setIcon(numberIcon);
        });
        
        // Add route lines if transport info exists
        {% if transport_info %}
        const routeColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
        {% for transport in transport_info %}
        {% if transport.route_points %}
        const routePoints{{ forloop.counter0 }} = {{ transport.route_points|safe }};
        if (routePoints{{ forloop.counter0 }} && routePoints{{ forloop.counter0 }}.length > 0) {
            L.polyline(routePoints{{ forloop.counter0 }}, {
                color: routeColors[{{ forloop.counter0 }} % routeColors.length],
                weight: 4,
                opacity: 0.7
            }).addTo(map).bindPopup('{{ transport.from }} to {{ transport.to }}<br>{{ transport.distance }} - {{ transport.duration }}');
        }
        {% endif %}
        {% endfor %}
        {% endif %}
        
        // Fit map to show all markers
        if (places.length > 1) {
            const group = new L.featureGroup(map._layers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
}
{% endif %}
</script>

{% endblock %}
